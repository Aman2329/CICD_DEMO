name: Generate Release Branch

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-release-branch:
    runs-on: ubuntu-latest

    steps:
      #  Allow workflow ONLY from develop
      - name: Restrict workflow to develop branch
        run: |
          if [ "${GITHUB_REF_NAME}" != "develop" ]; then
            echo "‚ùå This workflow can only be run from the develop branch"
            echo "‚û°Ô∏è Selected branch: ${GITHUB_REF_NAME}"
            exit 1
          fi

      #  Checkout full repository history
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      #  Configure Git identity
      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      #  Calculate next release-1.1.x version (STRICT & SAFE)
      - name: Calculate next release version
        id: release
        run: |
          set -e
          git fetch --all

          # Match ONLY release-1.1.X where X is numeric
          latest_release=$(git branch -r \
            | grep -E "^\s*origin/release-1\.1\.[0-9]+$" \
            | sed 's|origin/||' \
            | sed 's/^[[:space:]]*//' \
            | sort -V \
            | tail -n 1)

          if [ -z "$latest_release" ]; then
            version="1.1.0"
          else
            patch=$(echo "$latest_release" | awk -F. '{print $3}')

            if ! [[ "$patch" =~ ^[0-9]+$ ]]; then
              echo "‚ùå Failed to extract valid patch number from: $latest_release"
              exit 1
            fi

            next_patch=$((patch + 1))
            version="1.1.$next_patch"
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "release_branch=release-$version" >> $GITHUB_OUTPUT
          echo "tag=v$version" >> $GITHUB_OUTPUT

      #  Create release branch FROM develop (duplicate-safe)
      - name: Create and push release branch
        run: |
          set -e

          # Prevent duplicate branch creation
          if git ls-remote --heads origin "${{ steps.release.outputs.release_branch }}" | grep -q "${{ steps.release.outputs.release_branch }}"; then
            echo "‚ùå Branch ${{ steps.release.outputs.release_branch }} already exists remotely"
            exit 1
          fi

          git checkout develop
          git pull origin develop

          git checkout -b ${{ steps.release.outputs.release_branch }}
          git push origin ${{ steps.release.outputs.release_branch }}

      #  Create and push Git tag
      - name: Create and push Git tag
        run: |
          git tag ${{ steps.release.outputs.tag }}
          git push origin ${{ steps.release.outputs.tag }}

      #  Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          name: Release ${{ steps.release.outputs.tag }}
          body: |
            üöÄ **Release ${{ steps.release.outputs.tag }}**

            - Branch: `${{ steps.release.outputs.release_branch }}`
            - Source: `develop`
            - Repository: `rb-sales`

            Generated automatically via GitHub Actions.
